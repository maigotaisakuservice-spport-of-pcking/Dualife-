rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Free Mode: Anonymous posts (thoughts)
    match /thoughts/{thoughtId} {
      // Anyone can read posts.
      allow read;

      // Rules for creating new posts.
      allow create: if request.resource.data.localUserId is string
                    && request.resource.data.localUserId.size() > 0
                    && request.resource.data.nickname is string
                    && request.resource.data.nickname.size() > 0 && request.resource.data.nickname.size() < 30
                    && request.resource.data.text is string
                    && request.resource.data.text.size() > 0 && request.resource.data.text.size() < 280
                    && request.resource.data.ipAddress is string
                    && request.resource.data.ipAddress.size() > 0
                    && request.resource.data.createdAt == request.time
                    && request.resource.data.expireAt is timestamp
                    // imageUrl is optional, but if it exists, it must be a string.
                    && (!('imageUrl' in request.resource.data) || request.resource.data.imageUrl is string);

      // Updating and deleting posts is not allowed.
      allow delete: if false;

      // Rules for reacting to posts (stamps)
      // This allows updating only the 'reactions' map.
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']);
    }

    // School Mode: Groups
    match /groups/{groupId} {
      // Anyone can check if a group exists (for joining).
      allow get;

      // Rules for creating a new group.
      allow create: if request.resource.data.createdBy is string
                    && request.resource.data.createdBy.size() > 0
                    && request.resource.data.createdAt == request.time;

      // Deleting a group.
      // WARNING: In the current login-less system, there is no secure way to verify
      // the user is the owner on the backend. Deletion is disabled in the security rules.
      // To enable this, you must implement user authentication and check the user's UID.
      allow delete: if false;


      // Subcollection: Contact Book (messages)
      match /messages/{messageId} {
        // Allow read/write if the group document exists.
        // A more secure rule would check for group membership.
        allow read, write: if exists(/databases/$(database)/documents/groups/$(groupId))
                         && request.resource.data.senderId is string
                         && request.resource.data.senderNickname is string
                         && request.resource.data.text is string && request.resource.data.text.size() < 1000
                         && request.resource.data.type in ['important', 'chat']
                         && request.resource.data.createdAt == request.time;
      }

      // Subcollection: Event Album (album)
      match /album/{imageId} {
        // Allow read/write if the group document exists.
        allow read, write: if exists(/databases/$(database)/documents/groups/$(groupId))
                         && request.resource.data.uploaderId is string
                         && request.resource.data.uploaderNickname is string
                         && request.resource.data.imageUrl is string
                         && request.resource.data.createdAt == request.time;
      }
    }
  }
}
