// Dualife用 Firestoreセキュリティルール (最終版)
// =================================================

/*
Firebaseコンソールの「Firestore Database」 -> 「ルール」タブに以下の内容をコピー＆ペーストしてデプロイしてください。

【ルールの概要】
1.  フリーモード (`thoughts`):
    - 誰でも投稿を読むことができます。
    - 新しい投稿を作成するには、`ipAddress`や`localUserId`などの必須フィールドがすべて含まれている必要があります。これにより、不正な形式のデータ書き込みを防ぎます。
    - 投稿の更新と削除は、ユーザーからは直接行えないように禁止しています（削除はTTL機能が担当）。

2.  スクールモード (`groups`):
    - グループの存在確認のため、グループ本体のドキュメントは誰でも読めます（ただし、招待コードは推測困難）。
    - 認証システムがないため、「招待コードを知っている = グループのメンバーである」とみなし、グループ内のサブコレクション（`messages`, `album`）への読み書きを許可しています。これは完全なセキュリティではありませんが、ログイン不要という要件の中での次善策です。
    - メッセージやアルバムへの書き込み時にも、`senderId`などの必須フィールドチェックを行っています。
*/

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // フリーモード: 公開タイムラインの投稿
    match /thoughts/{thoughtId} {
      // 誰でも投稿を読むことができる
      allow read: if true;

      // 投稿を作成するには、必須フィールドがすべて存在する必要がある
      allow create: if request.resource.data.ipAddress is string &&
                      request.resource.data.localUserId is string &&
                      request.resource.data.nickname is string &&
                      request.resource.data.text is string &&
                      request.resource.data.expireAt is timestamp;

      // ユーザーによる更新・削除は禁止
      allow update, delete: if false;
    }

    // スクールモード: プライベートグループ
    match /groups/{groupId} {
      // グループの存在確認のために読み取りを許可
      allow read: if true;

      // グループの作成を許可
      allow create: if request.resource.data.createdBy is string;

      // グループ自体の更新・削除は禁止
      allow update, delete: if false;

      // グループ内の連絡帳(messages)サブコレクション
      match /messages/{messageId} {
        // グループドキュメントが存在すれば（＝有効な招待コードなら）読み書きを許可
        allow read, write: if exists(/databases/$(database)/documents/groups/$(groupId));

        // 作成時にはさらにフィールドを検証
        allow create: if exists(/databases/$(database)/documents/groups/$(groupId)) &&
                       request.resource.data.senderId is string &&
                       request.resource.data.text is string &&
                       request.resource.data.type is string;
      }

      // グループ内のアルバム(album)サブコレクション
      match /album/{imageId} {
        // グループドキュメントが存在すれば読み書きを許可
        allow read, write: if exists(/databases/$(database)/documents/groups/$(groupId));

        // 作成時にはさらにフィールドを検証
        allow create: if exists(/databases/$(database)/documents/groups/$(groupId)) &&
                       request.resource.data.uploaderId is string &&
                       request.resource.data.imageUrl is string;
      }
    }
  }
}
